apiVersion: batch/v1
kind: Job
metadata:
  name: rds-table-setup-job
  namespace: web-tier
  labels:
    app: rds-setup
    component: database-migration
    version: "1.0.0"
spec:
  # Job ì™„ë£Œ í›„ ìë™ ì •ë¦¬ (24ì‹œê°„ í›„)
  ttlSecondsAfterFinished: 86400
  # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
  backoffLimit: 3
  # 10ë¶„ ë‚´ì— ì™„ë£Œë˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: rds-setup
        component: database-migration
    spec:
      # Job ì™„ë£Œ í›„ Pod ì¬ì‹œì‘ ì•ˆí•¨
      restartPolicy: Never
      
      # ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999

      containers:
      - name: postgres-client
        image: postgres:17-alpine
        
        # í™˜ê²½ ë³€ìˆ˜
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: rds-credentials
              key: password
        - name: PGHOST
          valueFrom:
            secretKeyRef:
              name: rds-credentials
              key: host
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: rds-credentials
              key: username
        - name: PGDATABASE
          valueFrom:
            secretKeyRef:
              name: rds-credentials
              key: database
        - name: PGPORT
          value: "5432"
        
        # ì‹¤í–‰ ëª…ë ¹
        command:
        - /bin/sh
        - -c
        - |
          echo "=========================================="
          echo "RDS PostgreSQL í…Œì´ë¸” ì„¤ì • ì‹œì‘"
          echo "=========================================="
          echo "í˜¸ìŠ¤íŠ¸: $PGHOST"
          echo "ì‚¬ìš©ì: $PGUSER"
          echo "ë°ì´í„°ë² ì´ìŠ¤: $PGDATABASE"
          echo "í¬íŠ¸: $PGPORT"
          echo ""
          
          # RDS ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ”Œ RDS ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          if psql -c "SELECT version();" > /dev/null 2>&1; then
            echo "âœ… RDS ì—°ê²° ì„±ê³µ"
          else
            echo "âŒ RDS ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi
          echo ""
          
          # ê¸°ì¡´ í…Œì´ë¸” í™•ì¸
          echo "ğŸ” ê¸°ì¡´ í…Œì´ë¸” í™•ì¸ ì¤‘..."
          EXISTING_TABLES=$(psql -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          echo "ê¸°ì¡´ í…Œì´ë¸” ìˆ˜: $EXISTING_TABLES"
          echo ""
          
          # SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          echo "ğŸ“œ í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          if psql -f /sql/setup-tables.sql; then
            echo "âœ… í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ"
          else
            echo "âŒ í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
            exit 1
          fi
          echo ""
          
          # ìƒì„±ëœ í…Œì´ë¸” í™•ì¸
          echo "ğŸ“Š ìƒì„±ëœ í…Œì´ë¸” í™•ì¸ ì¤‘..."
          NEW_TABLES=$(psql -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          echo "ì´ í…Œì´ë¸” ìˆ˜: $NEW_TABLES"
          echo ""
          
          echo "ğŸ“‹ í…Œì´ë¸” ëª©ë¡:"
          psql -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name;"
          echo ""
          
          # í•„ìˆ˜ í…Œì´ë¸” ì¡´ì¬ í™•ì¸
          echo "ğŸ” í•„ìˆ˜ í…Œì´ë¸” ì¡´ì¬ í™•ì¸ ì¤‘..."
          REQUIRED_TABLES="users user_profiles products categories crawl_jobs analysis_requests analysis_results"
          MISSING_TABLES=""
          
          for table in $REQUIRED_TABLES; do
            if psql -t -c "SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = '$table';" | grep -q 1; then
              echo "âœ… $table"
            else
              echo "âŒ $table (ëˆ„ë½)"
              MISSING_TABLES="$MISSING_TABLES $table"
            fi
          done
          
          if [ -n "$MISSING_TABLES" ]; then
            echo ""
            echo "âŒ ëˆ„ë½ëœ í•„ìˆ˜ í…Œì´ë¸”ì´ ìˆìŠµë‹ˆë‹¤: $MISSING_TABLES"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ RDS PostgreSQL í…Œì´ë¸” ì„¤ì • ì™„ë£Œ!"
          echo "=========================================="
          echo "âœ… ëª¨ë“  í•„ìˆ˜ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "âœ… íšŒì›ê°€ì…/ë¡œê·¸ì¸ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥"
          echo "âœ… í¬ë¡¤ë§ ê²°ê³¼ ì €ì¥ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥"
          echo "=========================================="
        
        # ë³¼ë¥¨ ë§ˆìš´íŠ¸
        volumeMounts:
        - name: sql-script
          mountPath: /sql
          readOnly: true
        
        # ë¦¬ì†ŒìŠ¤ ì œí•œ
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        # ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      
      # ë³¼ë¥¨ ì •ì˜
      volumes:
      - name: sql-script
        configMap:
          name: rds-table-setup-sql
          defaultMode: 0444
      
      # ë…¸ë“œ ì„ íƒì (ì„ íƒì‚¬í•­)
      nodeSelector:
        kubernetes.io/arch: arm64
      
      # í†¨ëŸ¬ë ˆì´ì…˜ (ì„ íƒì‚¬í•­)
      tolerations:
      - key: "node.kubernetes.io/not-ready"
        operator: "Exists"
        effect: "NoExecute"
        tolerationSeconds: 300

---
# RDS ìê²© ì¦ëª… ì‹œí¬ë¦¿ (ì‹¤ì œ ë°±ì—”ë“œ ì„¤ì •ì— ë§ì¶¤)
apiVersion: v1
kind: Secret
metadata:
  name: rds-credentials
  namespace: web-tier
  labels:
    app: rds-setup
    component: database-credentials
type: Opaque
stringData:
  host: "airflow-metadata-db.cxkoo6wi2dyy.ap-northeast-2.rds.amazonaws.com"
  username: "kosa_user"
  password: "secure_password_2024"
  database: "kosa_db"